<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoLister - Scrape Queue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/scrape-queue.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">AutoLister</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/scrape-queue">Scrape Queue</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="bi bi-list-task"></i> Scrape Job Queue</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newJobModal">
                        <i class="bi bi-plus-lg"></i> New Scrape Job
                    </button>
                </div>
            </div>
        </div>

        <!-- Queue Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Queued Jobs</h5>
                        <h2 class="stat-number" id="queued-jobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card info">
                    <div class="card-body text-center">
                        <h5 class="card-title">Scheduled Jobs</h5>
                        <h2 class="stat-number" id="scheduled-jobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Completed Jobs</h5>
                        <h2 class="stat-number" id="completed-jobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed Jobs</h5>
                        <h2 class="stat-number" id="failed-jobs">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Scrape Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="current-scrape-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> Current Scrape Status</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshCurrentScrape()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="current-scrape-container">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-pause-circle fs-1"></i>
                                <p class="mt-2">No scrape job currently running</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Job Queue</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAutostart()" id="autostart-toggle-btn">
                                <i class="bi bi-play-circle"></i> Autostart: <span id="autostart-status">Off</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshQueue()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="queue-container">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No jobs in queue. Create a new scrape job to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Job Modal -->
    <div class="modal fade" id="newJobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> New Scrape Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="jobConfigTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                                <i class="bi bi-sliders"></i> Manual Config
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">
                                <i class="bi bi-magic"></i> AI Generate
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="jobConfigTabsContent">
                        <!-- Manual Configuration Tab -->
                        <div class="tab-pane fade show active" id="manual" role="tabpanel">
                            <form id="manualJobForm">
                                <div class="mb-3">
                                    <label class="form-label">Job Name</label>
                                    <input type="text" class="form-control" id="jobName" value="Service Manuals Collection" placeholder="e.g., Vintage Camera Manuals">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Source Type</label>
                                    <select class="form-select" id="sourceType">
                                        <option value="search" selected>Search Engine</option>
                                        <option value="forum">Forums</option>
                                        <option value="manual_site">Manual Sites</option>
                                        <option value="gdrive">Google Drive</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Search Query</label>
                                    <input type="text" class="form-control" id="searchQuery" value="service manual filetype:pdf -preview -operator -operation -user" placeholder="e.g., vintage camera manual filetype:pdf">
                                    <div class="form-text">Edit this query to customize your search. The default excludes preview, operator, operation, and user manuals.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Results</label>
                                    <input type="number" class="form-control" id="maxResults" value="20" min="1" max="100">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Search Terms (comma-separated)</label>
                                    <input type="text" class="form-control" id="searchTerms" value="service manual, repair manual, workshop manual, service station manual" placeholder="e.g., service manual, repair manual, workshop manual">
                                    <div class="form-text">These terms help identify relevant documents during scraping.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Exclude Terms (comma-separated)</label>
                                    <input type="text" class="form-control" id="excludeTerms" value="preview, operator, operation, user manual" placeholder="e.g., preview, operator, user manual">
                                    <div class="form-text">Documents containing these terms will be filtered out.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minimum PDF Pages</label>
                                    <input type="number" class="form-control" id="minPages" value="5" min="1" max="500">
                                    <div class="form-text">Only PDFs with at least this many pages will be included (helps exclude previews).</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Traversal Pattern</label>
                                    <textarea class="form-control" id="traversalPattern" rows="2" placeholder="e.g., Follow links containing: download, manual, service">Follow links containing: download, manual, service, repair, workshop</textarea>
                                    <div class="form-text">Pattern for finding PDF links on web pages during traversal.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Schedule (Optional)</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="datetime-local" class="form-control" id="scheduleTime">
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-select" id="scheduleFrequency">
                                                <option value="">Run Once</option>
                                                <option value="daily">Daily</option>
                                                <option value="weekly">Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-text">Leave empty to run immediately (queued)</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Equipment Type (Optional)</label>
                                    <input type="text" class="form-control" id="equipmentType" placeholder="e.g., Camera, Radio, etc.">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Manufacturer (Optional)</label>
                                    <input type="text" class="form-control" id="manufacturer" placeholder="e.g., Canon, Nikon, etc.">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autostartEnabled">
                                        <label class="form-check-label" for="autostartEnabled">
                                            <i class="bi bi-play-circle"></i> Enable Autostart
                                        </label>
                                        <div class="form-text">Automatically start the next job in queue when this job completes</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!-- AI Generation Tab -->
                        <div class="tab-pane fade" id="ai" role="tabpanel">
                            <form id="aiJobForm">
                                <div class="mb-3">
                                    <label class="form-label">Job Name</label>
                                    <input type="text" class="form-control" id="aiJobName" value="Service Manuals Collection" placeholder="e.g., Vintage Camera Manuals">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Describe what you want to scrape</label>
                                    <textarea class="form-control" id="aiPrompt" rows="5" placeholder="e.g., I want to find vintage camera service manuals from the 1970s, specifically for Canon and Nikon cameras. Look for PDF files on manual sites and forums. Get about 20 results. Focus on service manuals, repair manuals, workshop manuals, and service station manuals. Exclude operator, operation, and user manuals. Only include PDFs longer than 5 pages.">Find service manuals for equipment. The AI will generate a search query that focuses on service manuals, repair manuals, workshop manuals, and service station manuals. It will exclude preview PDFs, operator manuals, operation manuals, and user manuals. Only PDFs with more than 5 pages will be included.</textarea>
                                    <div class="form-text">Edit this description to customize what the AI generates for your search.</div>
                                </div>
                                <button type="button" class="btn btn-primary w-100" id="generateConfigBtn" onclick="generateScrapeConfig()">
                                    <i class="bi bi-magic"></i> Generate Configuration
                                </button>
                                <div id="aiLoading" class="text-center mt-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Generating configuration with AI...</p>
                                </div>
                                <div id="aiResult" class="mt-3" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6><i class="bi bi-check-circle"></i> Configuration Generated!</h6>
                                        <p class="mb-0">Review and adjust the settings below, then click "Create Job".</p>
                                    </div>
                                    <hr>
                                    <h6>Generated Settings:</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Job Name</label>
                                        <input type="text" class="form-control" id="aiGeneratedJobName">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Source Type</label>
                                        <select class="form-select" id="aiGeneratedSourceType">
                                            <option value="search">Search Engine</option>
                                            <option value="forum">Forums</option>
                                            <option value="manual_site">Manual Sites</option>
                                            <option value="gdrive">Google Drive</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Search Query</label>
                                        <input type="text" class="form-control" id="aiGeneratedQuery">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Max Results</label>
                                        <input type="number" class="form-control" id="aiGeneratedMaxResults" min="1" max="100">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Search Terms (comma-separated)</label>
                                        <input type="text" class="form-control" id="aiGeneratedSearchTerms">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Exclude Terms (comma-separated)</label>
                                        <input type="text" class="form-control" id="aiGeneratedExcludeTerms">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Minimum PDF Pages</label>
                                        <input type="number" class="form-control" id="aiGeneratedMinPages" min="1" max="500">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Traversal Pattern</label>
                                        <textarea class="form-control" id="aiGeneratedTraversalPattern" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Equipment Type</label>
                                        <input type="text" class="form-control" id="aiGeneratedEquipmentType">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Manufacturer</label>
                                        <input type="text" class="form-control" id="aiGeneratedManufacturer">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Schedule (Optional)</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <input type="datetime-local" class="form-control" id="aiGeneratedScheduleTime">
                                            </div>
                                            <div class="col-md-6">
                                                <select class="form-select" id="aiGeneratedScheduleFrequency">
                                                    <option value="">Run Once</option>
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-text">Leave empty to run immediately (queued)</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createScrapeJob()">
                        <i class="bi bi-plus-lg"></i> Create Job
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div class="modal fade" id="editJobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Scrape Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editJobForm">
                        <input type="hidden" id="editJobId">
                        <div class="mb-3">
                            <label class="form-label">Job Name</label>
                            <input type="text" class="form-control" id="editJobName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Type</label>
                            <select class="form-select" id="editSourceType">
                                <option value="search">Search Engine</option>
                                <option value="forum">Forums</option>
                                <option value="manual_site">Manual Sites</option>
                                <option value="gdrive">Google Drive</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Search Query</label>
                            <input type="text" class="form-control" id="editSearchQuery">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Results</label>
                            <input type="number" class="form-control" id="editMaxResults" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="datetime-local" class="form-control" id="editScheduleTime">
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select" id="editScheduleFrequency">
                                        <option value="">Run Once</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Equipment Type</label>
                            <input type="text" class="form-control" id="editEquipmentType">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="editManufacturer">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateScrapeJob()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/scrape-queue.js"></script>
</body>
</html>
